<!DOCTYPE html>  <html> <head>   <title>url_manager.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.js               </a>                                           <a class="source" href="base.html">                 base.js               </a>                                           <a class="source" href="cache.html">                 cache.js               </a>                                           <a class="source" href="conf.html">                 conf.js               </a>                                           <a class="source" href="cookies.html">                 cookies.js               </a>                                           <a class="source" href="cubrid.html">                 cubrid.js               </a>                                           <a class="source" href="error_handler.html">                 error_handler.js               </a>                                           <a class="source" href="fileHandler.html">                 fileHandler.js               </a>                                           <a class="source" href="js.html">                 js.js               </a>                                           <a class="source" href="less.html">                 less.js               </a>                                           <a class="source" href="gzip.html">                 gzip.js               </a>                                           <a class="source" href="headers.html">                 headers.js               </a>                                           <a class="source" href="pagelet.html">                 pagelet.js               </a>                                           <a class="source" href="server.html">                 server.js               </a>                                           <a class="source" href="session.html">                 session.js               </a>                                           <a class="source" href="url_manager.html">                 url_manager.js               </a>                                           <a class="source" href="url_patterns.html">                 url_patterns.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               url_manager.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span><span class="p">([</span><span class="s1">&#39;url_patterns&#39;</span><span class="p">,</span> <span class="s1">&#39;requirejs&#39;</span><span class="p">,</span> <span class="s1">&#39;conf&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;session&#39;</span><span class="p">,</span> <span class="s1">&#39;error_handler&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">url_patterns</span><span class="p">,</span> <span class="nx">requirejs</span><span class="p">,</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">error_handler</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">regExpStore</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pattern</span> <span class="k">in</span> <span class="nx">url_patterns</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">regExpStore</span><span class="p">[</span><span class="nx">pattern</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="nx">pattern</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">pulsrController</span><span class="p">,</span> <span class="nx">domain</span><span class="p">,</span> <span class="nx">portIx</span><span class="p">,</span> <span class="nx">siteDir</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <pre><code>   domain = request.headers['host'];

   // exclude port suffix
   if ((portIx = domain.indexOf(':')) &gt; -1) {
       domain = domain.substring(0, portIx);
   }

   console.log(domain);

   for (var d in conf.app.sites) {
       if (domain.indexOf(d) &gt; -1) {
           siteDir = conf.app.sites[d].path.root;
           break;
       }
   }

   if (siteDir !== undefined) {
       console.log(siteDir);
   }
   else{
       // if not host is matched, display the default site
   }
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">function</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">controller</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>start session here for all user defined controllers
pulsr fileManager controller should not set any
session information for static resources.
All cookies for static resources should be ignored.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">session</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="nx">controller</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">errback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <pre><code>       console.log(err);
</code></pre>

<p>this function is called when no user defined controller
is found. It such case it falls back and searches among
pulsr's controller.
No Pulsr controller is called here except for fileHandler
which ignores cookies and should not set any session data.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">requirejs</span><span class="p">([</span><span class="nx">pulsrController</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">controller</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Internal Server Error. This should not have happened
as fileHandler controller MUST BE in Pulsr.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">error_handler</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="p">{</span><span class="nx">errno</span><span class="o">:</span> <span class="mi">500</span><span class="p">});</span>
            <span class="p">});</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>redirect all root domain requests to www. subdomain
to make sure no cookies are set to the root domain
which are useless when requesting static resources.
       console.log(request.headers);
       urlObj = url.parse(request.headers.host);
       console.log(urlObj);
       if (!urlObj.hostname.test(/^www./)) {
           console.log('no www');
       }
       else{
           console.log('www exists');
       }</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">request</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>retrieve the request data in one tick.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">request</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>once all data has been received from the client,
handle the request.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">request</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pattern</span> <span class="k">in</span> <span class="nx">regExpStore</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">regExpStore</span><span class="p">[</span><span class="nx">pattern</span><span class="p">].</span><span class="nx">exec</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">)))</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">controllerPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">dir</span><span class="p">.</span><span class="nx">controllers</span><span class="p">,</span> <span class="nx">url_patterns</span><span class="p">[</span><span class="nx">pattern</span><span class="p">]);</span>

                    <span class="nx">pulsrController</span> <span class="o">=</span> <span class="nx">url_patterns</span><span class="p">[</span><span class="nx">pattern</span><span class="p">];</span>
                    <span class="nx">request</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nx">match</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>JSlint doesn't like when functions are defined inside for loops,
so I'm taking these functions out.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">requirejs</span><span class="p">([</span><span class="nx">controllerPath</span><span class="p">],</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>break the loop since we've already found the first match</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
  <span class="p">};</span>
<span class="p">});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 